var fs = require('fs')
var xml2js = require('xml2js')
var request = require('request')

var parser = new xml2js.Parser({
  mergeAttrs: true,
  explicitArray: false
});

fd = fs.openSync('/tmp/bgg.json', 'a')

parser.addListener('end', function(result) {
  if(result.items.item.length) {
    for(var i = 0; i<result.items.item.length; i++) {
      fs.writeSync(fd, JSON.stringify(result.items.item[i])+'\n')
    }
  }else {
    fs.writeSync(fd, JSON.stringify(result.items.item)+'\n')
  }
});

console.log('running');
var threadId = 0;
var batchSize = 35;
var maxBatches = 2000;

var startIndex = 107451;
var index = startIndex;
var maxIndex = startIndex + (batchSize * maxBatches) - 1;
var pauseMs = 6321;

function fetchNext() {
  ids = [];
  for(i=0;i<batchSize;i++){
    ids.push(index + i);
  }
  index += batchSize;
  console.log("requesting "+ids.join(','))

  request({url:"http://www.boardgamegeek.com/xmlapi2/thing?id="+ids.join(',')+'&stats=1&comments=1',json:false}, function(err, res, body) {
    if(res && res.statusCode == 200) {
      parser.parseString(body)
    }else {
      console.log('failed',err, ids, res);
    }
  });
  if(index > maxIndex) {
    console.log('reached maxIndex, clearing interval')
    clearInterval(threadId);
  }
}
threadId = setInterval(fetchNext, pauseMs)

